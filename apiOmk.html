<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>API Omeka S — Gestion des Ressources Culturelles + Audio/Video</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f3e9; padding: 20px; }
        h1, h2 { color: #6d4c41; }
        .box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px #ccc; margin-bottom: 20px; }
        input, select, button { padding: 8px; margin: 5px 0; }
        button { background: #795548; color: white; border: none; cursor: pointer; }
        button:hover { background: #5d4037; }
        pre { background: #eee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<h1> API Omeka S — Gestion des Ressources Culturelles + Audio/Video</h1>

<!-- Paramètres API -->
<div class="box">
    <h2> Paramètres API</h2>
    <label>URL Omeka S :</label><br>
    <input id="omkUrl" size="60" value="http://localhost/omekas/api/"><br>
    <label>Clé API :</label><br>
    <input id="apiKey" size="60" value="cJtHjx5XTjh4fM7qqnmLT2fj5DgPqvrW">
</div>

<!-- Choisir une ressource -->
<div class="box">
    <h2> Choisir une ressource</h2>
    <select id="resourceType">
        <option value="items?resource_template_id=4">Document</option>
        <option value="items?resource_template_id=7">Événement</option>
        <option value="items?resource_template_id=6">Lieu</option>
        <option value="items?resource_template_id=5">Projet</option>
        <option value="items?resource_template_id=3">Utilisateur</option>
    </select>
    <br><br>
    <button onclick="charger()"> Charger les données</button>
</div>

<!-- Affichage résultat -->
<div class="box">
    <h2> Résultat API</h2>
    <pre id="resultat">...</pre>
</div>

<!-- Ajouter une ressource -->
<div class="box">
    <h2>➕ Ajouter une nouvelle ressource</h2>
    <label>Titre :</label><br>
    <input id="titre" size="50"><br>
    <label>Description :</label><br>
    <input id="description" size="50"><br>
    <label>Auteur :</label><br>
    <input id="auteur" size="50"><br>
    <label>Date de création :</label><br>
    <input id="date_creation" type="date"><br>
    <label>Est lié à (ID) :</label><br>
    <input id="estLie" size="50"><br>
    <label>Fichier audio :</label><br>
    <input type="file" id="audioFile" accept="audio/*"><br>
    <label>Fichier vidéo :</label><br>
    <input type="file" id="videoFile" accept="video/*"><br><br>
    <button onclick="ajouter()"> Envoyer à Omeka</button>
</div>

<script>
// Charger les ressources
function charger() {
    const url = document.getElementById("omkUrl").value;
    const key = document.getElementById("apiKey").value;
    const type = document.getElementById("resourceType").value;

    fetch(url + type, { headers: { "Authorization": "Bearer " + key } })
        .then(res => res.json())
        .then(data => { document.getElementById("resultat").textContent = JSON.stringify(data, null, 2); })
        .catch(err => { document.getElementById("resultat").textContent = "Erreur : " + err; });
}

// Ajouter une ressource + fichiers
function ajouter() {
    const url = document.getElementById("omkUrl").value + "items";
    const key = document.getElementById("apiKey").value;
    const type = document.getElementById("resourceType").value;
    const templateId = type.split("=")[1];

    const data = {
        "o:resource_template": { "o:id": templateId },
        "o:title": document.getElementById("titre").value,
        "dcterms:description": [{ "type": "literal", "property_id": 4, "value": document.getElementById("description").value }],
        "dcterms:creator": [{ "type": "literal", "property_id": 3, "value": document.getElementById("auteur").value }],
        "dcterms:created": [{ "type": "literal", "property_id": 5, "value": document.getElementById("date_creation").value }],
        "o:relation": [{ "type": "literal", "property_id": 6, "value": document.getElementById("estLie").value }]
    };

    // Créer la ressource
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + key },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(item => {
        // Ajouter les fichiers audio/vidéo si présents
        const fichiers = [
            { inputId: "audioFile" },
            { inputId: "videoFile" }
        ];

        fichiers.forEach(f => {
            const fileInput = document.getElementById(f.inputId);
            if (fileInput.files.length > 0) {
                const formData = new FormData();
                formData.append("file", fileInput.files[0]);
                formData.append("o:owner", "1"); // ID du propriétaire

                fetch(url + "/" + item["o:id"] + "/media", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + key },
                    body: formData
                })
                .then(res => res.json())
                .then(media => { 
                    document.getElementById("resultat").textContent += "\n\nFichier ajouté : " + JSON.stringify(media, null, 2);
                })
                .catch(err => { document.getElementById("resultat").textContent += "\n\nErreur fichier : " + err; });
            }
        });

        document.getElementById("resultat").textContent += "\n\nRessource créée : " + JSON.stringify(item, null, 2);
    })
    .catch(err => { document.getElementById("resultat").textContent = "Erreur : " + err; });
}
</script>

</body>
</html>
